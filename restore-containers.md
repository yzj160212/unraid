# Docker 容器备份恢复脚本

## 功能简介

`restore-containers.sh` 是一个专门用于恢复 Docker 容器及其数据的脚本。主要功能包括：

1. **智能备份检测**
   - 自动检测最新备份
   - 验证备份完整性
   - 多线程解压支持

2. **数据恢复**
   - 恢复 appdata 目录
   - 还原容器配置
   - 重建容器状态
   - 并行恢复多个容器

## 使用方法

### 基本使用
```bash
sudo ./restore-containers.sh
```

### 恢复流程
1. 检测最新可用备份
2. 恢复 appdata 目录数据
3. 并行启动容器
4. 验证容器健康状态

### 恢复内容
- 完整的 appdata 目录
- 容器配置和状态
- Docker Compose 设置
- 容器运行环境

## 重要特性

### 智能恢复机制
- 自动检测最新备份
- 多线程解压缩
- 并行容器恢复
- 高效数据传输

### 健康检查
- 容器启动验证
- 健康状态监控
- 自动重试机制
- 详细错误报告

### 安全特性
- 备份完整性验证
- 临时目录使用
- 错误自动回滚
- 状态实时监控

## 执行过程

1. **初始化**
   - 检查环境
   - 验证权限
   - 确认依赖

2. **备份检测**
   - 查找最新备份
   - 验证备份完整性
   - 准备恢复环境

3. **数据恢复**
   - 多线程解压备份
   - 恢复目录结构
   - 更新文件权限

4. **容器重建**
   - 并行启动容器
   - 验证运行状态
   - 健康状态检查

## 注意事项

1. **系统要求**
   - root 权限
   - Docker 环境
   - rsync 工具
   - zstd 支持

2. **恢复说明**
   - 自动选择最新备份
   - 最多并行恢复 3 个容器
   - 支持健康检查和重试

3. **重要提示**
   - 确保足够磁盘空间
   - 检查网络连接
   - 注意权限设置
   - 备份文件格式为 .tar.zst

## 错误处理

1. **常见问题**
   - 备份文件损坏
   - 空间不足
   - 权限错误
   - 网络问题

2. **故障排除**
   - 检查错误日志
   - 验证备份文件
   - 确认系统资源
   - 查看容器日志

## 技术支持

- 日志位置：`/mnt/user/logs/docker_restore_*.log`
- 临时文件：`/tmp/docker_restore_*`
- 错误报告：自动生成在临时目录
- 备份格式：zstd 压缩的 tar 文件

## 最佳实践

1. **恢复准备**
   - 确认系统状态
   - 检查资源可用性
   - 确保足够磁盘空间
   - 验证备份文件完整性

2. **执行建议**
   - 系统负载低时执行
   - 监控恢复进度
   - 关注错误日志
   - 验证容器状态

3. **后续操作**
   - 验证服务可用性
   - 检查数据完整性
   - 清理临时文件
   - 确认所有容器正常运行 