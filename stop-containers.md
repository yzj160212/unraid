# Docker 容器安全停止与备份脚本

## 功能简介

`stop-containers.sh` 是一个专门用于安全停止 Docker 容器并创建备份的脚本。它能够：

1. **智能停止容器**
   - 按依赖关系顺序停止容器
   - 支持优雅停止和强制停止
   - 自动处理容器间的依赖关系

2. **自动备份**
   - 创建容器配置备份
   - 保存容器运行状态
   - 全量备份 appdata 目录
   - 多线程压缩备份

## 使用方法

### 基本使用
```bash
sudo ./stop-containers.sh
```

### 执行流程
1. 扫描并停止所有运行中的容器
2. 创建容器状态备份
3. 全量备份 appdata 目录
4. 生成详细的操作日志

### 备份内容
- 容器配置文件
- 容器运行状态
- 完整的 appdata 目录

## 重要特性

### 安全停止机制
- 优雅停止（等待 3 秒）
- SIGTERM 信号处理（等待 10 秒）
- 必要时强制停止

### 备份策略
- 全量备份机制
- 多线程 zstd 压缩
- 自动验证备份完整性
- 保留 30 天备份历史

### 日志记录
- 详细的操作日志
- 错误信息记录
- 备份状态报告
- 压缩率统计

## 目录结构

```
/mnt/user/
├── appdata/              # 容器数据目录
├── backups/
│   ├── docker_state/    # 容器状态备份
│   └── docker_configs/  # 配置文件备份
└── logs/                # 脚本运行日志
```

## 注意事项

1. **运行要求**
   - 需要 root 权限
   - 需要安装 docker 和 docker-compose
   - 需要安装 zstd（用于压缩）
   - 确保足够的磁盘空间

2. **备份说明**
   - 备份文件格式：`appdata_时间戳.tar.zst`
   - 状态文件格式：`容器名_时间戳.json`
   - 使用多线程压缩提升性能
   - 自动保留 30 天的备份历史

3. **安全建议**
   - 执行前确保重要数据已备份
   - 确保足够的磁盘空间
   - 建议在系统负载较低时执行
   - 监控备份过程

## 常见问题

1. **容器无法停止**
   - 检查容器日志
   - 确认容器状态
   - 查看依赖关系
   - 检查网络连接

2. **备份失败**
   - 检查磁盘空间
   - 验证目录权限
   - 查看错误日志
   - 确认 zstd 可用性

## 技术支持

- 日志位置：`/mnt/user/logs/docker_stop_*.log`
- 备份位置：`/mnt/user/backups/`
- 配置目录：`/mnt/user/appdata/`
- 压缩格式：zstd 压缩的 tar 文件

## 最佳实践

1. **执行时机**
   - 系统负载低时执行
   - 系统更新前执行
   - 重要更改前执行
   - 定期执行备份

2. **监控建议**
   - 监控备份过程
   - 检查备份文件大小
   - 验证备份完整性
   - 关注压缩效率

3. **维护建议**
   - 定期清理旧备份
   - 检查磁盘空间
   - 验证备份可用性
   - 测试恢复流程 