# Docker 容器安全停止与备份脚本

## 功能简介

`stop-all-containers.sh` 是一个专门用于安全停止 Docker 容器并创建备份的脚本。它能够：

1. **智能停止容器**
   - 按依赖关系顺序停止容器
   - 支持优雅停止和强制停止
   - 自动处理容器间的依赖关系

2. **自动备份**
   - 创建容器配置备份
   - 保存容器运行状态
   - 备份整个 appdata 目录
   - 支持增量备份策略

## 使用方法

### 基本使用
```bash
sudo ./stop-all-containers.sh
```

### 执行流程
1. 扫描并停止所有运行中的容器
2. 创建容器状态备份
3. 备份 appdata 目录
4. 生成详细的操作日志

### 备份内容
- 容器配置文件
- 容器运行状态
- 完整的 appdata 目录
- 增量备份数据

## 重要特性

### 安全停止机制
- 优雅停止（等待 3 秒）
- SIGTERM 信号处理（等待 10 秒）
- 必要时强制停止

### 备份策略
- 每周自动全量备份
- 其他时间执行增量备份
- 使用 zstd 压缩
- 自动验证备份完整性

### 日志记录
- 详细的操作日志
- 错误信息记录
- 备份状态报告

## 目录结构

```
/mnt/user/
├── appdata/              # 容器数据目录
├── backups/
│   ├── docker_state/    # 容器状态备份
│   └── docker_configs/  # 配置文件备份
└── logs/                # 脚本运行日志
```

## 注意事项

1. **运行要求**
   - 需要 root 权限
   - 需要安装 docker 和 docker-compose
   - 需要安装 zstd（用于压缩）

2. **备份说明**
   - 备份文件格式：`appdata_时间戳.tar.zst`
   - 状态文件格式：`容器名_时间戳.json`
   - 自动保留 30 天的备份历史

3. **安全建议**
   - 执行前确保重要数据已备份
   - 确保足够的磁盘空间
   - 建议在系统负载较低时执行

## 常见问题

1. **容器无法停止**
   - 检查容器日志
   - 确认容器状态
   - 查看依赖关系

2. **备份失败**
   - 检查磁盘空间
   - 验证目录权限
   - 查看错误日志

## 技术支持

- 日志位置：`/mnt/user/logs/docker_stop_*.log`
- 备份位置：`/mnt/user/backups/`
- 配置目录：`/mnt/user/appdata/`

## 最佳实践

1. **定期执行**
   - 建议每周执行一次完整备份
   - 系统更新前执行备份
   - 重要更改前执行备份

2. **监控建议**
   - 定期检查备份文件
   - 验证备份完整性
   - 及时清理旧备份 